version: '3.8'

services:
  rag-api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: rag-api
    ports:
      - "9009:8000"
    env_file:
      - .env
    environment:
      # Qdrant bağlantısı (.env'den geliyor)
      - QDRANT_HOST=${QDRANT_HOST}
      - QDRANT_PORT=${QDRANT_PORT}

      # Ollama / LLM (host başka stack'te ama ismi sabit; yine de override edilebilir)
      - OLLAMA_HOST=${OLLAMA_HOST:-llm-ollama}
      - OLLAMA_PORT=${OLLAMA_PORT:-11434}

      # LRS Mongo bağlantısı (başka stack fakat ortak network'te)
      - LRS_MONGO_HOST=${LRS_MONGO_HOST:-lrs-mongo}
      - LRS_MONGO_PORT=${LRS_MONGO_PORT:-27017}
      - LRS_MONGO_DB_NAME=${LRS_MONGO_DB_NAME}
      - LRS_MONGO_COLLECTION=${LRS_MONGO_COLLECTION}

      # LLM + Embedding modeli
      - LLM_MODEL=${LLM_MODEL_NAME}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL}

      # xAPI LRS REST endpoint'i ve chunk ayarları
      - LRS_API_URL=${LRS_API_URL}
      - MAX_CHUNK_SIZE=${MAX_CHUNK_SIZE}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP}

      # İstersen Postgres tarafını da .env'den kullanabilirsin (ileride lazım olacak)
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - DB_PASSWORD=${DB_PASSWORD}
    networks:
      - rag_network
      - xapia_net
      - lrs_lrs-network  # ← GÜNCELLENDI: Doğru LRS network adı
    depends_on:
      - rag-qdrant
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/health', timeout=5)"]
      interval: 30s
      timeout: 30s
      retries: 3
      start_period: 40s

  rag-ui:
    build:
      context: ./ui
      dockerfile: Dockerfile
    container_name: rag-ui
    ports:
      - "9013:8501"
    env_file:
      - .env
    environment:
      # UI'nin API'ye bağlanacağı adres. İstersen .env'e RAG_API_URL ekleyip oradan yönetebilirsin.
      - RAG_API_URL=${RAG_API_URL:-http://rag-api:8000}
    networks:
      - rag_network
    depends_on:
      - rag-api
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8501', timeout=5)"]
      interval: 30s
      timeout: 30s
      retries: 3
      start_period: 40s

  rag-qdrant:
    image: qdrant/qdrant:latest
    container_name: rag-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_storage:/qdrant/storage
    networks:
      - rag_network
    restart: unless-stopped

networks:
  rag_network:
    driver: bridge
  xapia_net:
    external: true
  lrs_lrs-network:  # ← GÜNCELLENDI: LRS stack'in gerçek network adı
    external: true
    name: lrs_lrs-network  # ← EKLENDI: Explicit network name

volumes:
  qdrant_storage: